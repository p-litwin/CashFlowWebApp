{% extends "base.html" %}

{% block title %}CashFlowApp - Lista transakcji{% endblock %}

{% block footer %}
<script type="text/javascript" src="/js/addIncomeForm.js"></script>
<script type="text/javascript" src="/js/addExpenseForm.js"></script>
<script type="text/javascript" src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
{% endblock %}

{% block body %}

{% include "navbar.html" %}
<div class="container-fluid main-content">
  <div class="row site-title">
    <h1>Lista transakcji</h1>
  </div>

   <!--Expense edit Modal -->
   <div class="modal fade" id="expensesEditModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title fs-5" id="exampleModalLabel">Edytuj wydatek</h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form method="post" id="expenseForm" action="/expenses/update">
            <input type="hidden" name="user_id" value="{{ current_user.userId }}">
            <input type="hidden" id="expenseId" name="id" value="{{ transaction.transaction_id }}">
            <div class="form-outline  mb-4 has-validation">
              <label class="form-label" for="expenseAmount">Kwota</label>
              <input class="form-control auto-highlight" type="number" id="expenseAmount" min="0.00" step="0.01" name="amount"
                value="{% if expense.amount is not empty %}{{expense.amount}}{% else %}0,00{% endif %}" required>
            </div>

            <div class="form-outline mb-4 has-validation">
              <input class="form-control single-date-picker" type="text" id="expenseDate" name="date"
                value="{% if expense.date is not empty %}{{expense.date}}{% else %}{{current_date}}{% endif %}"
                pattern="[0-9]{4}-[0-9]{2}-[0-9]{2}" readonly>
              <label class="form-label single-date-picker" for="expenseDate">Data (RRRR-MM-DD)</label>
            </div>


            <div class="form-outline mb-4 has-validation">
              <select class="form-control" id="paymentMethod" name="payment_method" placeholder="Sposób płatności">
                <option value="">Wybierz opcję</option>
                {% for method in payment_methods %}
                {% if method.id == last_expense_payment_method %}
                <option value="{{ method.id }}" selected>{{ method.name }}</option>
                {% else %}
                <option value="{{ method.id }}">{{ method.name }}</option>
                {% endif %}
                {% endfor %}
              </select>
              <label class="form-label" for="paymentMethod">Sposób płatności:</label>
            </div>


            <div class="form-outline mb-4 has-validation">
              <select class="form-control" id="expenseCategory" placeholder="Kategoria" name="category">
                <option value=""></option>
                {% for category in expenses_categories %}
                {% if category.id == last_expense_category %}
                <option value="{{ category.id }}" selected>{{ category.name }}</option>
                {% else %}
                <option value="{{ category.id }}">{{ category.name }}</option>
                {% endif %}
                {% endfor %}
              </select>
              <label class="form-label" for="expenseCategory">Kategoria:</label>
            </div>


            <div class="form-outline mb-2 has-validation">
              <textarea class="form-control" id="expenseComment" name="comment"></textarea>
              <label class="form-label" for="expenseComment">Komentarz:</label>
            </div>
            
            <div class="modal-footer">
              <a role="button" class="btn btn-secondary" data-bs-dismiss="modal">Anuluj</a>
              <button type="submit" class="btn btn-primary">Zapisz zmiany</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
  <!--Expense edit Modal end -->
  <!--Income edit Modal -->
  <div class="modal fade" id="incomesEditModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title fs-5" id="exampleModalLabel">Edytuj przychód</h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form method="post" id="incomeForm" action="/incomes/update">
            <input type="hidden" name="user_id" value="{{ current_user.userId }}">
            <input type="hidden" id="incomeId" name="id" value="{{transactions.transactions_id}}">
            <div class="form-outline  mb-4 has-validation">
              <label class="form-label" for="incomeAmount">Kwota</label>
              <input class="form-control auto-highlight" type="number" id="incomeAmount" min="0.00" step="0.01" name="amount"
                value="{% if income.amount is not empty %}{{income.amount}}{% else %}0,00{% endif %}" required>
            </div>
            <div class="form-outline mb-4 has-validation">
              <input class="form-control single-date-picker" type="text" id="incomeDate" name="date"
                value="{% if income.date is not empty %}{{income.date}}{% else %}{{current_date}}{% endif %}"
                pattern="[0-9]{4}-[0-9]{2}-[0-9]{2}" readonly>
              <label class="form-label single-date-picker" for="incomeDate">Data (RRRR-MM-DD)</label>
            </div>
            <div class="form-outline mb-4 has-validation">
              <select class="form-control" id="incomeCategory" placeholder="Kategoria" name="category">
                <option value=""></option>
                {% for category in incomes_categories %}
                {% if category.id == last_income_category %}
                <option value="{{ category.id }}" selected>{{ category.name }}</option>
                {% else %}
                <option value="{{ category.id }}">{{ category.name }}</option>
                {% endif %}
                {% endfor %}
              </select>
              <label class="form-label" for="incomeCategory">Kategoria:</label>
            </div>
            <div class="form-outline mb-2 has-validation">
              <textarea class="form-control" id="incomeComment" name="comment"></textarea>
              <label class="form-label" for="incomeComment">Komentarz:</label>
            </div>
            <div class="modal-footer">
              <a role="button" class="btn btn-secondary" data-bs-dismiss="modal">Anuluj</a>
              <button type="submit" class="btn btn-primary">Zapisz zmiany</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
  <!--Income edit Modal end -->
  <!-- Transactions list -->
  {% if transactions %}
        {% set previous = false %}      
        {% for transaction in transactions %}
          {% if previous == false  %}
            <div class="date-container">
              <p class="transaction-date">{{transaction.date}}</p>
              <hr>
            </div>
            {% set previous = transaction %}
          {% else %}
            {% if transaction.date == previous.date %}
            {% else %}
            <div class="date-container">
              <p class="transaction-date">{{transaction.date}}</p>
              <hr>
            </div>
            {% set previous = transaction %}
            {% endif %}
          {% endif %}
        <div class="card shadow-sm mb-1">
          <div class="card-body ps-2 pt-2 pb-2 pe-2 transaction-details d-flex justify-content-between">
            <div class="col-lg-10 col-md-10 col-sm-10 col-7">
              <div class="row">
              <div class="col-sm-6 col-12 no-wrap-text transaction-category" title="{{transaction.name}}">{{transaction.name}}</div>
              {% if transaction.comment is empty %}
                <div class="col-sm-6 col-12 no-wrap-text text-body-secondary" title="Brak opisu">(Brak opisu)</div>
              {% else %}
                <div class="col-sm-6 col-12 no-wrap-text transaction-comment" title="{{transaction.comment}}">{{transaction.comment}}</div>
              {% endif %}
              </div>
            </div>
            <div class="col-lg-2 col-md-2 col-sm-2 col-5 justify-content-end">
              <div class="row ps-4 pe-3 h-100">  
                <div class="col-11 amount {{transaction.type}}-amount">{{transaction.amount}} zł</div>
                <div class="col-1 ps-0 pe-0 transaction-ellipsis text-end">
                  <div class="dropdown">
                    <a class="" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                      <i class="fa-solid fa-ellipsis-vertical"></i>
                    </a>
                    <ul class="dropdown-menu ellipsis-menu">
                      <li><button class="btn btn-block" href="/transactions-list/delete" data-bs-target="#exampleModal">
                        <i class="fa-solid fa-trash-can" style="color: #f00006;"></i> Delete</button></li>
                        <li><button class="btn btn-block" data-bs-id="{{transaction.transaction_id}}" data-bs-toggle="modal" data-bs-target="#{{transaction.type}}EditModal" data-bs-amount="{{transaction.amount}}" data-bs-category="{{transaction.category_id}}" data-bs-payment="{{transaction.payment_method}}" data-bs-date="{{transaction.date}}" data-bs-comment="{{transaction.comment}}"><i class="fa-solid fa-pen-to-square"></i> Edit</button></li>
                    </ul>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        {% endfor %}
  {% else %}
  No transactions to show
  {% endif %}
<!-- Transactions list end -->
<!-- Pagination -->
  <nav class="mt-4">
    <ul class="pagination justify-content-center">
      {% if page == 1 %}
        <li class="page-item page-link"><i class="fa-solid fa-angles-left" style="color: #c0c0c0;"></i></li>
      {% else %}
        <li class="page-item"><a class="page-link" sr-only="Pierwsza strona" title="Pierwsza strona" href="/transactions-list/show/1"><i class="fa-solid fa-angles-left"></i></a></li>
      {% endif %}
      {% if page == 1 %}
        <li class="page-item page-link"><i class="fa-solid fa-angle-left" style="color: #c0c0c0;"></i></li>
      {% else %}
        <li class="page-item"><a class="page-link" sr-only="Poprzednia strona" title="Poprzednia strona" href="/transactions-list/show/{{previous_page}}"><i class="fa-solid fa-angle-left"></i></a></li>
      {% endif %}
      <li class="page-item"><span class="page-link">Strona {{page}} z {{last_page}}</span></li>
      {% if page >= last_page %}
        <li class="page-item page-link"><i class="fa-solid fa-angle-right" style="color: #c0c0c0;" ></i></li>
      {% else %}
        <li class="page-item"><a class="page-link" sr-only="Następna strona" title="Następna strona" href="/transactions-list/show/{{next_page}}"><i class="fa-solid fa-angle-right"></i></a></li>
      {% endif %}
      {% if page == last_page %}
        <li class="page-item page-link"><i class="fa-solid fa-angles-right" style="color: #c0c0c0;" ></i></li>
      {% else %}
        <li class="page-item"><a class="page-link" sr-only="Ostatnia strona" title="Ostatnia strona" href="/transactions-list/show/{{last_page}}"><i class="fa-solid fa-angles-right"></i></a></li>
      {% endif %}
    </ul>
  </nav>
<!-- Pagination end -->
</div>
{% endblock %}